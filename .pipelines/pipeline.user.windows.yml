environment:
  host:
    os: 'windows'
    flavor: 'server'
    version: '2019'
  runtime:
    provider: 'appcontainer'
    image: 'cdpxwin1809.azurecr.io/global/vse2019:latest'
    source_mode: 'map'

signing_options:
  profile: 'azure'
  codesign_validation_glob_pattern: 'regex|.+(?:dll|exe|sys|ps1|psm1|ps1xml|psc1|psd1|cdxml|vbs|js|wsf)$;-:file|**\linux\**' #CSV does not currently support binaries built for linux, so we exclude this folder


restore:
  commands:
    - !!defaultcommand
      name: 'Restore submodules'
      command: '.pipelines/restore_submodules.cmd'
    - !!defaultcommand
      name: 'IGVMAgent Restore'
      command: 'src/IGVMAgent/restore.cmd'

build:
  commands:
    - !!buildcommand
      name: 'Build IGVMAgent'
      command: 'src\IGVMAgent\build.cmd'
      artifacts:
        - from: 'src\IGVMAgent\release\agent'
          to: 'Windows_IGVMAgent'
          include:
            - '**/*'
          signing_options:
            sign_inline: true

test:
  commands:
    - !!testcommand
      name: 'Test IGVMAgent'
      command: 'src\IGVMAgent\test.cmd'
      fail_on_stderr: false
      logs:
        - to: 'test-igvmagent-logs'
          include:
            - '**/*.trx'
            - '**/*.coverage'
      testresults:
        - from: 'src\IGVMAgent\release\tests'
          title: 'IGVMAgent-tests'
          type: 'VSTest'
          include:
            - '**/*.trx'
            - '**/*.coverage'

static_analysis_options:
  policheck_options:
    scan_comments: true
    files_to_scan:
      - from: 'src\IGVMAgent'
      - exclude:
        - 'src\IGVMAgent\**.cmd'
        - 'src\IGVMAgent\**.config'
        - 'src\IGVMAgent\**.acf'
        - 'src\IGVMAgent\**.idl'
        - 'src\IGVMAgent\**.txt'
        - 'src\IGVMAgent\**.md'
  binskim_options:
    files_to_scan:
      - from: 'src\IGVMAgent'
  moderncop_options:
    files_to_scan:
      - from: 'src\IGVMAgent'